// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Form submissions table - stores all form data submissions
model FormSubmission {
  id        String   @id @default(cuid())
  data      Json     // Store the dynamic form data as JSON
  schemaId  String?  // Optional reference to the form schema used
  ipAddress String?  @db.VarChar(45) // Store IP address for analytics (IPv4/IPv6)
  userAgent String?  @db.Text // Store user agent for analytics
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to form schema (optional)
  schema FormSchema? @relation(fields: [schemaId], references: [id], onDelete: SetNull)

  // Indexes for better query performance
  @@index([createdAt])
  @@index([schemaId])
  @@map("form_submissions")
}

// Form schemas table - stores the JSON schemas for dynamic forms
model FormSchema {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100) // Unique name for the schema
  schema      Json     // Store the JSON schema definition
  description String?  @db.Text
  isActive    Boolean  @default(true)
  version     Int      @default(1) // Schema versioning
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to submissions
  submissions FormSubmission[]

  // Indexes
  @@index([name])
  @@index([isActive])
  @@index([createdAt])
  @@map("form_schemas")
}

// Analytics cache table - for storing pre-computed analytics
model AnalyticsCache {
  id            String   @id @default(cuid())
  cacheKey      String   @unique @db.VarChar(255) // Unique key for the cached data
  data          Json     // Cached analytics data
  expiresAt     DateTime // When this cache entry expires
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Index for efficient cache lookups
  @@index([cacheKey])
  @@index([expiresAt])
  @@map("analytics_cache")
}

// Form field definitions table - for storing common field configurations
model FormFieldTemplate {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(100) // Field name
  type        String   @db.VarChar(50)  // Field type (text, email, etc.)
  label       String   @db.VarChar(200) // Display label
  config      Json     // Field configuration (validation rules, options, etc.)
  isPublic    Boolean  @default(true)   // Whether this template is publicly available
  usageCount  Int      @default(0)      // How many times this template has been used
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Indexes
  @@index([name])
  @@index([type])
  @@index([isPublic])
  @@map("form_field_templates")
}

// System logs table - for audit trails and debugging
model SystemLog {
  id        String   @id @default(cuid())
  level     String   @db.VarChar(20) // log level (info, warn, error, debug)
  message   String   @db.Text
  context   Json?    // Additional context data
  source    String?  @db.VarChar(100) // Source of the log (service, controller, etc.)
  createdAt DateTime @default(now())

  // Indexes for log queries
  @@index([level])
  @@index([createdAt])
  @@index([source])
  @@map("system_logs")
}
